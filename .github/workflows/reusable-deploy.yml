name: Reusable Deploy Workflow

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (prod, stage, dev)'
        required: true
        type: string
      app-name:
        description: 'Name of the application to deploy'
        required: true
        type: string
    secrets:
      deploy-token:
        description: 'Token for deployment authentication'
        required: true
    outputs:
      deployment-url:
        description: 'The URL of the deployed application'
        value: ${{ jobs.deploy.outputs.deployment-url }}

jobs:
  deploy:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    outputs:
      deployment-url: ${{ steps.deploy-info.outputs.deployment-url }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Display matrix info
      run: |
        echo "ğŸ§© Running on ${{ matrix.os }} | Environment: ${{ inputs.environment }} | App: ${{ inputs.app-name }}"

    - name: Validate Environment
      shell: bash
      run: |
        VALID_ENVS=("prod" "stage" "dev")
        ENVIRONMENT="${{ inputs.environment }}"  # assign to bash variable
        if [[ ! " ${VALID_ENVS[@]} " =~ " ${ENVIRONMENT} " ]]; then
        echo "::error::Invalid environment: ${ENVIRONMENT}"
        echo "::error::Allowed environments: ${VALID_ENVS[*]}"
        exit 1
        fi
        echo "âœ… Environment validation passed"
    - name: Set deployment URL
      id: deploy-info
      run: |
        if [[ "${{ inputs.environment }}" == "prod" ]]; then
          echo "deployment-url=https://${{ inputs.app-name }}.example.com" >> $GITHUB_OUTPUT
        elif [[ "${{ inputs.environment }}" == "stage" ]]; then
          echo "deployment-url=https://stage-${{ inputs.app-name }}.example.com" >> $GITHUB_OUTPUT
        else
          echo "deployment-url=https://dev-${{ inputs.app-name }}.example.com" >> $GITHUB_OUTPUT
        fi
    
    - name: Deploy Application
      env:
        DEPLOY_TOKEN: ${{ secrets.deploy-token }}
      run: |
        echo "ğŸš€ Deploying ${{ inputs.app-name }} to ${{ inputs.environment }}"
        echo "ğŸ“ Target URL: ${{ steps.deploy-info.outputs.deployment-url }}"
        echo "ğŸ”‘ Using token: ${DEPLOY_TOKEN:0:5}***"
        echo "âœ… Deployment simulated successfully"